groups:
  - name: sr AlertRules
    rules:
      - alert: RedisMemoryUsedAlert
        expr: sr_redis_memory_used_bytes{product_component='sr',module=~'redis-biz|redis-cache'} / sr_redis_memory_max_bytes{product_component='sr', module=~'redis-biz|redis-cache'} > 0.9
        for: 10m
        labels:
          alarm_alias: Redis 内存使用率超过90%
          alarm_level: P3
          alarm_desc: Redis 内存使用率超过90%
          alarm_cf: https://doc.sensorsdata.cn/pages/viewpage.action?pageId=233541971
          alarm_rd: 赵硕义
        annotations:
          summary: 'redis memory used over 90% for 10 min'
          description: 'redis memory used {{ $value }} for 10 min. redis_type={{ $labels.module }}, redis_instance={{ $labels.instance }}'
          value: '{{ $value }}'

      - alert: ExceptionRequestAlert
        expr: sum(sr_web_service_request{code!="200", code!='404'}) by (customer_id, instance, job, module, product_component, module_role, project) > 5 and sum(sr_web_service_request{code!="200", code!='404'}) by (customer_id, instance, job, module, product_component, module_role, project) / sum(sr_web_service_request) by (customer_id, instance, job, module, product_component, module_role,project) > 0.005
        for: 3m
        labels:
          alarm_alias: web service异常请求占比
          alarm_level: P2
          alarm_desc: 异常请求占比超过5‰
          alarm_cf: https://doc.sensorsdata.cn/pages/viewpage.action?pageId=233541971
          alarm_rd: 赵硕义
        annotations:
          summary: 'The proportion of abnormal requests exceeds five thousandths'
          description: 'The proportion of abnormal web service request per min is {{ $value }} for 3 min. project={{ $labels.project }}'
          value: '{{ $value }}'

      - alert: ResponseTimeTimeoutAlert
        expr: sr_web_service_request_time_tp90{product_component='sr',module="sr_nginx"} > 0.5
        for: 3m
        labels:
          alarm_alias: Web Service 响应时间过大
          alarm_level: P3
          alarm_desc: Web Service P90 响应时间超过0.5s
          alarm_cf: https://doc.sensorsdata.cn/pages/viewpage.action?pageId=233541971
          alarm_rd: 赵硕义
        annotations:
          summary: 'The Response Time of P90 web service request exceeds 0.5s'
          description:  'The Response Time of P90 web service request is {{ $value }} for 3 min. project={{ $labels.project }} ,instance={{ $labels.instance}}'
          value: '{{ $value }}'

      - alert: SRDataFlowFailAlert
        expr: sr_dataflow_status{product_component='sr',module="redis-dataflow"} < 1
        labels:
          alarm_alias: SR 离线数据流报警
          alarm_level: P3
          alarm_desc: SR 离线数据流运行失败
          alarm_cf: https://doc.sensorsdata.cn/pages/viewpage.action?pageId=233541971
          alarm_rd: 赵硕义
        annotations:
          summary: 'SR 离线数据流运行失败'
          description:  'The azkaban datafow fail. project={{ $labels.project }} ,dataflow_name={{ $labels.dataflow_name}}, status={{ $labels.status }}'
          value: '{{ $value }}'
